<html>

<head>
  <meta charset="UTF-8">
  <title>LeanGate Monitor</title>

  <link rel="stylesheet" type="text/css" href="styles.css" />

</head>

<body>

  <div class="sidebar" id="sidebar"></div>
  <div class="content">
    <div class="headline" id="headline">
      <div class="updated" id="dataUpdated">updated 2 seconds ago</div>
      <div class="name" id="nodeName">leangate-node-1</div>
      <div class="info">
        <div class="block os" id="osName">Debian GNU/Linux 9</div>
        <div class="block cpuModel" id="cpuMode">Intel® Core™ i7-6700HQ</div>
        <div class="block cpuCores" id="cpuCores">2 Cores x 2.60Hz</div>
        <div class="block uptime" id="nodeUptime">Uptime 20 minutes</div>
      </div>
    </div>
    <div class="containers" id="containers">
      <div class="item title">
        <div class="name">Name</div>
        <div class="user">User</div>
        <div class="state">State</div>
        <div class="actions">Actions</div>
      </div>
      <div class="item">
        <div class="name">vlc</div>
        <div class="user">20348710319470</div>
        <div class="state green">running</div>
        <div class="actions">
          <div class="button red">Kill</div>
          <div class="button blue">Migrate</div>
        </div>
      </div>
      <div class="item">
        <div class="name">firefox</div>
        <div class="user">20348710319470</div>
        <div class="state orange">stopped</div>
        <div class="actions">
          <div class="button green">Run</div>
        </div>
      </div>
      <div class="item">
        <div class="name">0332103482021</div>
        <div class="user">20348710319470</div>
        <div class="state green">running</div>
        <div class="actions">
          <div class="button red">Kill</div>
          <div class="button blue">Migrate</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let selectedNode = null;

    const sidebar = document.getElementById("sidebar");
    const headline = document.getElementById("headline");
    const containers = document.getElementById("containers");
    const dataUpdated = document.getElementById("dataUpdated");
    const nodeName = document.getElementById("nodeName");
    const osName = document.getElementById("osName");
    const cpuModel = document.getElementById("cpuModel");
    const cpuCores = document.getElementById("cpuCores");
    const nodeUptime = document.getElementById("nodeUptime");

    function redrawSidebar(nodes) {

      sidebar.innerHTML = "";

      for (const node of nodes) {

        const nodeNameValue = node["node"];
        const cpuLoadValue = Math.floor(node["metrics"]["cpuLoad"]["currentload"]);
        const ramLoadValue = Math.floor(node["metrics"]["ram"]["used"] / node["metrics"]["ram"]["total"] * 100);
        let runningContainersValue = 0;
        let stoppedContainersValue = 0;

        for (const container of node["metrics"]["dockerContainers"]) {
          if (container.state === "running") {
            runningContainersValue++;
          } else {
            stoppedContainersValue++;
          }
        }

        if (!selectedNode) selectedNode = nodeNameValue;

        const nodeDOM = document.createElement("div");
        nodeDOM.classList.add("element");
        if (nodeNameValue === selectedNode) nodeDOM.classList.add("selected");

        nodeDOM.on("click", () => {
          switchNode(nodeDOM, nodeNameValue);
        });

        const nodeName = document.createElement("div");
        nodeName.classList.add("name");
        nodeName.innerText = nodeNameValue;
        nodeDOM.appendChild(nodeName);

        const nodeDescription = document.createElement("div");
        nodeDescription.classList.add("description");
        nodeDescription.innerText = `${runningContainersValue} running, ${stoppedContainersValue} stopped`;
        nodeDOM.appendChild(nodeDescription);

        const nodeCpuLoader = document.createElement("div");
        nodeCpuLoader.classList.add("loader");
        const nodeCpuLoaderBar = document.createElement("div");
        nodeCpuLoaderBar.classList.add("bar");
        const nodeCpuLoaderFill = document.createElement("div");
        nodeCpuLoaderFill.classList.add("fill");
        if (cpuLoadValue < 60) {
          nodeCpuLoaderBar.classList.add("green");
        } else if (cpuLoadValue < 90) {
          nodeCpuLoaderBar.classList.add("orange");
        } else {
          nodeCpuLoaderBar.classList.add("red");
        }
        nodeCpuLoaderFill.style.width = `${cpuLoadValue}%`
        nodeCpuLoaderBar.appendChild(nodeCpuLoaderFill);
        nodeCpuLoader.appendChild(nodeCpuLoaderBar);
        const nodeCpuLoaderPercentage = document.createElement("div");
        nodeCpuLoaderPercentage.classList.add("percentage");
        nodeCpuLoaderPercentage.innerText = `${cpuLoadValue}% CPU`
        nodeCpuLoader.appendChild(nodeCpuLoaderPercentage);
        nodeDOM.appendChild(nodeCpuLoader);

        const nodeRamLoader = document.createElement("div");
        nodeRamLoader.classList.add("loader");
        const nodeRamLoaderBar = document.createElement("div");
        nodeRamLoaderBar.classList.add("bar");
        const nodeRamLoaderFill = document.createElement("div");
        nodeRamLoaderFill.classList.add("fill");
        if (ramLoadValue < 60) {
          nodeRamLoaderBar.classList.add("green");
        } else if (ramLoadValue < 90) {
          nodeRamLoaderBar.classList.add("orange");
        } else {
          nodeRamLoaderBar.classList.add("red");
        }
        nodeRamLoaderFill.style.width = `${ramLoadValue}%`
        nodeRamLoaderBar.appendChild(nodeRamLoaderFill);
        nodeRamLoader.appendChild(nodeRamLoaderBar);
        const nodeRamLoaderPercentage = document.createElement("div");
        nodeRamLoaderPercentage.classList.add("percentage");
        nodeRamLoaderPercentage.innerText = `${ramLoadValue}% RAM`
        nodeRamLoader.appendChild(nodeRamLoaderPercentage);
        nodeDOM.appendChild(nodeRamLoader);

        sidebar.appendChild(nodeDOM);

      }
    }

    function redrawTable(nodes) {

      containers.innerHTML = "";

      for (const node of nodes) {
        if (node["node"] === selectedNode) {

          const lastUpdated = Math.floor(new Date().getTime() - node["updated"] / 1000);

          containers.innerHTML = "";
          dataUpdated.innerHTML = `updated ${lastUpdated} second${lastUpdated===1?"":"s"} ago`;
          nodeName.innerHTML = node["node"];
          osName.innerHTML = `${node["metrics"]["osInfo"]["distro"]} ${node["metrics"]["osInfo"]["release"]}`;
          cpuModel.innerHTML = `${node["metrics"]["cpuInfo"]["manufacturer"]} ${node["metrics"]["cpuInfo"]["brand"]}`;
          cpuCores.innerHTML = `${node["metrics"]["cpuInfo"]["cores"]} Core${node["metrics"]["cpuInfo"]["cores"]===1?"":"s"} x ${node["metrics"]["cpuInfo"]["speed"]}Hz`;
          nodeUptime.innerHTML = `Uptime ${node["metrics"]["time"]["uptime"]} seconds`;

          // TODO: fill containers

        }
      }

    }

    function switchNode(dom, node) {
      selectedNode = node;
      for (const elementDOM of sidebar.getElegetElementsByClassName("element")) {
        elementDOM.classList.remove("selected");
      }
      dom.classList.add("selected");
      containers.innerHTML = "";
      dataUpdated.innerHTML = "updating...";
      nodeName.innerHTML = "";
      osName.innerHTML = "";
      cpuModel.innerHTML = "";
      cpuCores.innerHTML = "";
      nodeUptime.innerHTML = "";
    }

    window.addEventListener('message', (event => {
      console.log("System answered!", event);
      redrawSidebar(event.data.results);
      redrawTable(event.data.results);
    }), false);

    setInterval(function() {
      window.parent.postMessage({
        "action": "apiCall",
        "endpoint": "system/getClusterMetrics"
      }, '*');
    }, 1000);
  </script>

</body>

</html>
